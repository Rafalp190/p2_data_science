---
title: "Proyecto 2"
author: "Oliver Mazariegos, Rafael Leon y Alejandro Vasquez"
date: "18/8/2018"
output: 
  html_document:

    number_sections: false

    toc: true

    fig_width: 8

    fig_height: 6
    
    self_contained: true

    theme: cosmo

    highlight: tango

    code_folding: hide
---


# Situación Problemática

No se ha buscado la relacion entre habilidades cognitivas, crecimiento y salud de los huesos utilizando los datos del estudio longitudinal de la UVG y los estudios que se han realizado con datos parecidos no han sido bien investigados en paises de bajos y medianos ingresos.

Los datos utilizados para este analisis son el producto de un estudio longitudinal diseñado por el Dr. Barry Bogin hace mas de 50 años en conjunto con el Colegio Americano de Guatemala. Ellos se propusieron a colectar datos longitudinalmente de estudiantes de todos los años y darle seguimiento a su crecimiento de forma anual hasta el momento en el que completaban sus estudios de bachillerato.
El estudio se expandió a 6 colegios más a lo largo de los años y se cuenta con datos de peso, talla, IQ, pruebas de lectura y masa osea para registros comenzando en el año 1953.

Esta base de datos pertenece a la fundación Bill and Melinda Gates, los cuales donaron los fondos necesarios para digitalizarla.

# Problema Cientifico


## Objetivos


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
opts_knit$set(root.dir = "~/R")
library(readxl)
library(dplyr)
library(Matrix)
library(data.table)
library(ggplot2)
library(rela)
library(psych)
library(FactoMineR)
```

# Conjunto de datos

## Leyendo Datos

* Subjects: Informacion personal de cada sujeto de prueba.
* Card1: Informacion fisiológica de los sujetos.
* Card2: Informacion fisiológica complementaria.

```{r lectura}

subjects = as.data.table(read_xlsx("./data/1-Subjects sex_ID_school_DOB.xlsx"))
card1 = as.data.table(read_xlsx("./data/4-Card1.xlsx"))
card2 = as.data.table(read_xlsx("./data/5-Card2.xlsx"))

```

### Variables desechadas

En las tres bases de datos existen registros de control de digitalizacion como.  

* `entering date`: Fecha en la que los datos fueron digitalizados.
* `User` : Usuario que digitalizó el dato.

Estas variables, por ser solo de control, junto a `Repetition` en `Card1` y `Card2`, que no esta presente en casi todo el conjunto de datos, seran desechadas.



###  Subject

En Subjects podemos encontrar las siguientes variables personales de cada sujeto de estudio.

* `ID`: Identificador personal para cada persona involucrada en el set de datos.
* `DOB`: Fecha de nacimiento de la persona.
* `DOB decimal`: Año de nacimiento de la persona en representacion decimal.
* `Sex`: Sexo de la persona.
* `IdSchool 1`: Identificador del colegio al que asistió la persona.
* `IdSchool 2`: Valor booleano que representa si el sujeto ya no estudia en el colegio representado en `IdSchool 1`

### Card1

En Card1 podemos encontrar las siguientes caracteristicas fisiologicas de los sujetos de observacion.  

* `yearCard1`: Año en el que se recopilaron los datos.
* `gradeCard1`: Grado escolar al que pertenecía la persona.
* `Height`: Altura de la persona en centimetros.
* `Weight`: Peso de la persona en kg.
* `Hand grip`: Fuerza de la mano calculado en kg.
* `Dental`: Dentición piezas del sujeto. Número de piezas permanentes eruptadas.

### Card2

En Card2 podemos encontrar las siguientes caracteristicas fisiologicas de los sujetos de observacion.  

* `yearCard2`: Año en el que se recopilaron los datos.
* `grade Card 2`: Grado escolar al que pertenecía la persona.
* `UAC1`: Circunferencia Tricep 1
* `UAC2`: Circunferencia Tricep 2
* `TST1`: Pliegue Cutáneo Tricep 1
* `TST2`: Pliegue Cutáneo Tricep 2
* `SSF1`: Pliegue Cutáneo Subescapular 1
* `SSF2`: Pliegue Cutáneo Subescapular 2

## Union y Limpieza de Datos

### Subject-Card1-Card2

```{r S12, warning=F,message=F}
mainData = subjects
c1 = card1
c2 = card2 

colnames(mainData)[1] <- "Id"
colnames(c1)[2] <- "date" 
colnames(c2)[2] <- "date"

cards <- merge(c1, c2, by = c("Id", "date"))
completeData <- merge(mainData, cards, by = "Id")
completeData$age <- round(completeData$date - completeData$`DOB decimal`, 0)
```

# Analisis Exploratorio

##Card1-Card2

### Exploración de variables y eliminacion de outlier

#### Frecuencia de edades

```{r frecEdad, warning=F,message=F}
ggplot(completeData, aes(x = age)) +
  geom_bar() +
  labs(x = "Edad", y = "Frecuencia")
```

#### Altura por Edad

```{r alturaEdad, warning=F,message=F}
ggplot(completeData, aes(group = age, x = age, y = Height)) +
  geom_boxplot() +
  labs(x = "Edad", y = "Altura (cm)")
```

Las alturas de más de 250 cm no tienen sentido. Además, las edades mayores a 22 años tienen muy pocos datos. Se decidió removerlos:


```{r alturaEdadRem, warning=F,message=F}
completeData <- completeData %>% 
  filter(Height < 250) %>% 
  filter(age < 23)
```

##### Sin outliers

```{r boxplot_height2, warning=F,message=F}
ggplot(completeData, aes(group = age, x = age, y = Height)) +
  geom_boxplot() +
  labs(x = "Edad", y = "Altura (cm)")
```




#### Pesos por Edades

```{r boxplot_weight1, warning=F,message=F}
ggplot(completeData, aes(group = age, x = age, y = Weight)) +
  geom_boxplot() +
  labs(x = "Edad", y = "Peso (kg)")
```


Pesos mayores a 200 kg no tienen sentidos. Se decidió eliminarlos:

```{r remoutWeight, warning=F,message=F}
completeData <- completeData %>% 
  filter(Weight < 200)
```

##### Sin outliers

```{r boxplot_weight2, warning=F,message=F}
ggplot(completeData, aes(group = age, x = age, y = Weight)) +
  geom_boxplot() +
  labs(x = "Edad", y = "Peso (kg)")
```




#### Regresion Lineal Peso-Altura

```{r peso_altura, warning=F,message=F}
for(i in 4:22){
  temp <- completeData %>% 
    filter(age == i)
  
  print(ggplot(temp, aes(x = Weight, y = Height)) + geom_point() + 
           labs(x = "Peso (kg)", y = "Altura (cm)", title = paste(i, " anos")) +
    geom_smooth(method = lm, se = F))
}

```

Solo existen 4 datos para mediciones con cuatro años de edad. Se eliminarán:


```{r rem_outliers2, warning=F,message=F}
completeData <- completeData %>% 
  filter(age > 4)
```


#### Altura-Dientes
```{r , warning=F,message=F}
ggplot(completeData, aes(group = Dental, x = Dental, y = Height)) +
  geom_boxplot() +
  labs(x = "Número de dientes", y = "Altura (cm)")
```

No tiene sentido que hayan niños tan altos sin dientes permanentes "erupcionados". Según la Asociación Dental de América, se espera que a partir de los 6-7 años por lo menos se hayan desarrollado los incisivos centrales. Probablemente esos "0"s signifiquen que no fue registrado el dato. Para comprobar cuántos registros de niños mayores años no tienen dientes permanentes "erupcionados":


```{r check_teeth_age, warning=F,message=F}
paste(round((nrow(filter(completeData, age > 7 & Dental == 0)) 
             / nrow(completeData) * 100),2), "%")
```

Más del 60% de los datos no tienen ese registro, por lo que no se utilizará esta columna.

```{r remove_Dental, warning=F,message=F}
completeData <- completeData %>% 
  mutate(Dental = NULL)
```


#### IdSchool | Repetition | RepetitionCard1

IdSchool2, que indica si se cambiaron de colegio parece tener muchos NAs. Chequear:

```{r check_idschool2, warning=F,message=F}
paste(round(nrow(filter(completeData, is.na(`IdSchool 2`))) / 
              nrow(completeData) * 100, 2), "%")
```

Casi el 100% de los registros no poseen esta información. Se eliminará esta columna. Además, se eliminarán las columnas *Repetition* y *RepetitionCard1* ya que estas proveen poca información acerca de la altura. Es más, los alumnos repitentes podrían distorsionar las predicciones.

```{r remove_idschool2_repetitions, warning=F,message=F}
colnames(completeData)[6] <- "IdSchool2"

completeData <- completeData %>% 
  mutate(IdSchool2 = NULL) %>% 
  mutate(Repetition = NULL) %>% 
  mutate(RepetitionCard1 = NULL)

```



#### Fuerza de Agarre (Hand grip)

Visualizar los datos de pruebas de fuerza de agarre:

```{r hand_grip, warning=F,message=F}
ggplot(completeData, aes(y = `Hand grip`, x = age, group = age)) +
  geom_boxplot() +
  labs(y = "fuerza de agarre (kg)", x = "Edad (años)")
```

No existen registros de pruebas de fuerza de agarre en los que se superen los 100 kg de fuerza de agarre, por lo que se eliminarán los outliers y se vuelve a graficar: 

```{r remove_handgrip_outliers, warning=F,message=F}
completeData <- completeData %>% 
  filter(`Hand grip` < 100)
```

##### Sin outliers

```{r hand_grip2, warning=F,message=F}
ggplot(completeData, aes(y = `Hand grip`, x = age, group = age)) +
  geom_boxplot() +
  labs(y = "fuerza de agarre (kg)", x = "Edad (años)")
```

#### Fuerza de Agarre-Edad

```{r plot_handgrip_by_age, warning=F,message=F}

for(i in 5:22){
  temp <- completeData %>% 
    filter(age == i)
  
  print(ggplot(temp, aes(x = `Hand grip`)) + 
          geom_bar() + 
           labs(y = "Frecuencia", 
                x = "fuerza de agarre (kg)", 
                title = paste(i, " años")
                )
  )
}



```

La fuerza de agarre presenta una distribución aparentemente normal desde los 5 hasta los 14 años. Sin embargo, a partir de los 15 años y sobre todo entre los 17 y 19 años, se pueden observar claramente dos distribuciones que se traslapan. Esto indica que en estas edades la diferencia de fuerza de agarre es mucho más marcada. Se tendrá esto en cuenta para futuras predicciones.





### Desecho de Variables

Se eliminarán otras variables poco útiles como *entering date*, *entering data* y *User*. También se eliminarán *DOB* y *DOB decimal* debido a que ya se calculó la edad en cada registro.

```{r remove_trash, warning=F,message=F}

completeData <- completeData %>% 
  mutate(`entering date` = NULL) %>% 
  mutate(`entering data` = NULL) %>% 
  mutate(User.x = NULL) %>% 
  mutate(User.y = NULL) %>% 
  mutate(DOB = NULL) %>% 
  mutate(`DOB decimal` = NULL)

```
# Analisís de Componentes Principales

Se evalurá la factibilidad de realizar un análisis de componentes principales utilizando la base de datos unificada del estudio.

```{r PCA_preview, warning=F,message=F}
pafDatos<-paf(as.matrix(completeData[,5:16]))
pafDatos$KMO
pafDatos$Bartlett
summary(pafDatos)
cortest.bartlett(completeData[,5:16])
```

Como se puede observar se obtuvo un KMO de *0.86* y un coeficiente de Bartlett muy elevado *2421661* por lo que parece que un analisis de componentes principales es una buena idea. Considerando que el valor P indicado es de 0. 

## Matriz de Correlación

```{r corrmat_pca, warning=F,message=F}
kable(cor(completeData[,5:16],use = "pairwise.complete.obs"))
```

En la matriz de correlación observamos que algunas variables se encuentran relacionadas por lo que se procederá a realizar el analisis de componentes principales para intentar reducir el dataset.

```{r pc, warning=F,message=F}
compPrinc<-prcomp(completeData[,5:16], scale = T)
compPrinc
summary(compPrinc)


```

```{r pca, warning=F,message=F}
compPrincPCA<-PCA(completeData[,5:16],ncp=ncol(completeData[,5:16]), scale.unit = T)
```







# Cluster

## Diagrama de Codo

```{r codoComplete, warning=F,message=F}
library(factoextra)
library(cluster)

cluster = completeData[,c('Sex','gradeCard1','Height','Weight','Hand grip','UAC1 cm','TST1 mm','SSF1 mm','age')]
cluster$Sex = as.factor(cluster$Sex)
cluster$Sex = as.numeric(cluster$Sex)

set.seed(12)

wss <- (nrow(cluster[,c()])-1)*sum(apply(cluster[,1:ncol(cluster)],2,var))

for (i in 2:10) 
  wss[i] <- sum(kmeans(cluster[,1:ncol(cluster)], centers=i)$withinss)

plot(2:
       10, wss[c(2:10)], type="b", xlab="Number of Cluster",  ylab="Squares Summatory", main = "Diagrama de Codo")

```

## Creacion de Cluster

```{r clusterComplet, warning=F,message=F}
require("fpc")
library(cluster)
set.seed(90)
km = kmeans(cluster, 4)
cluster$grupo<-km$cluster
completeData$grupo = km$cluster

g1 = completeData[cluster$grupo == 1,]
g2 = completeData[cluster$grupo == 2,]
g3 = completeData[cluster$grupo == 3,]
g4 = completeData[cluster$grupo == 4,]

plotcluster(cluster[,c(1:9)],cluster$grupo)

```


## Analisis Express {.tabset .tabset-fade}

### Edad

```{r edadCC, warning=F,message=F}
ggplot(data = completeData, aes(group = grupo, y = age, fill = factor(grupo))) + geom_boxplot(outlier.shape = NA) + xlab("Grupos") + ggtitle("Edad") + ylim(c(0,25))
```

### Altura

```{r alturaCC, warning=F,message=F}
ggplot(data = completeData, aes(group = grupo, y = Height, fill = factor(grupo))) + geom_boxplot(outlier.shape = NA) + xlab("Grupos") + ggtitle("Altura (cm)") + ylim(c(100,200))
```

### Peso

```{r pesoCC, warning=F,message=F}
ggplot(data = completeData, aes(group = grupo, y = Weight, fill = factor(grupo))) + geom_boxplot(outlier.shape = NA) + xlab("Grupos") + ggtitle("Peso (kg)") + ylim(c(0,100))
```

### Hand grip

```{r Handgrip, warning=F,message=F}
ggplot(data = completeData, aes(group = grupo, y = `Hand grip`, fill = factor(grupo))) + geom_boxplot(outlier.shape = NA) + xlab("Grupos") + ggtitle("Hand grip") + ylim(c(0,70))
```

### Grade 

```{r gradeCC, warning=F,message=F}
ggplot(data = completeData, aes(group = grupo, y = gradeCard1, fill = factor(grupo))) + geom_boxplot(outlier.shape = NA) + xlab("Grupos") + ggtitle("Grado Escolar")
```

### UAC

```{r UACCC, warning=F,message=F}
ggplot(data = completeData, aes(group = grupo, y = `UAC1 cm`, fill = factor(grupo))) + geom_boxplot(outlier.shape = NA) + xlab("Grupos") + ggtitle("UAC1 cm") + ylim(c(10,40))
```

### TST

```{r TSTCC, warning=F,message=F}
ggplot(data = completeData, aes(group = grupo, y = `TST1 mm`, fill = factor(grupo))) + geom_boxplot(outlier.shape = NA) + xlab("Grupos") + ggtitle("TST1 mm") + ylim(c(0,35))
```

### SSF

```{r boxplotsCC, warning=F,message=F}
ggplot(data = completeData, aes(group = grupo, y = `SSF1 mm`, fill = factor(grupo))) + geom_boxplot(outlier.shape = NA) + xlab("Grupos") + ggtitle("SSF1 mm") + ylim(c(0,35))
```

## Genero {.tabset .tabset-fade}

### Grupo 1

```{r generoCC1, warning=F,message=F}
barplot(prop.table(table(g1$Sex)))
```

### Grupo 2

```{r generoCC2, warning=F,message=F}
barplot(prop.table(table(g2$Sex)))
```

### Grupo 3

```{r generoCC3, warning=F,message=F}
barplot(prop.table(table(g3$Sex)))
```

### Grupo 4

```{r generoCC4, warning=F,message=F}
barplot(prop.table(table(g4$Sex)))
```

## Altura-Edad {.tabset .tabset-fade}

### Grupo 1

```{r altura-edad1, warning=F,message=F}
ggplot(g1, aes(group = age, x = age, y = Height)) +
  geom_boxplot() +
  labs(x = "Edad", y = "Altura (cm)")
```

### Grupo 2

```{r altura-edad2, warning=F,message=F}
ggplot(g2, aes(group = age, x = age, y = Height)) +
  geom_boxplot() +
  labs(x = "Edad", y = "Altura (cm)")
```

### Grupo 3

```{r altura-eda3, warning=F,message=F}
ggplot(g3, aes(group = age, x = age, y = Height)) +
  geom_boxplot() +
  labs(x = "Edad", y = "Altura (cm)")
```

### Grupo 4

```{r altura-edad4, warning=F,message=F}
ggplot(g4, aes(group = age, x = age, y = Height)) +
  geom_boxplot() +
  labs(x = "Edad", y = "Altura (cm)")
```

## Hand Grip-Edad {.tabset .tabset-fade}

### Grupo 1

```{r HGCC1, warning=F,message=F}
ggplot(g1, aes(y = `Hand grip`, x = age, group = age)) +
  geom_boxplot() +
  labs(y = "fuerza de agarre (kg)", x = "Edad (anos)")
``` 

### Grupo 2

```{r HGCC2, warning=F,message=F}
ggplot(g2, aes(y = `Hand grip`, x = age, group = age)) +
  geom_boxplot() +
  labs(y = "fuerza de agarre (kg)", x = "Edad (anos)")
``` 

### Grupo 3

```{r HGCC3, warning=F,message=F}
ggplot(g3, aes(y = `Hand grip`, x = age, group = age)) +
  geom_boxplot() +
  labs(y = "fuerza de agarre (kg)", x = "Edad (anos)")
``` 

### Grupo 4

```{r HGCC4, warning=F,message=F}
ggplot(g4, aes(y = `Hand grip`, x = age, group = age)) +
  geom_boxplot() +
  labs(y = "fuerza de agarre (kg)", x = "Edad (anos)")
``` 

## Peso-Edad {.tabset .tabset-fade}

### Grupo 1

```{r WeightCC1, warning=F,message=F}
ggplot(g1, aes(group = age, x = age, y = Weight)) +
  geom_boxplot() +
  labs(x = "Edad", y = "Peso (kg)")
```  

### Grupo 2

```{r WeightCC2, warning=F,message=F}
ggplot(g2, aes(group = age, x = age, y = Weight)) +
  geom_boxplot() +
  labs(x = "Edad", y = "Peso (kg)")
``` 

### Grupo 3

```{r WeightCC3, warning=F,message=F}
ggplot(g3, aes(group = age, x = age, y = Weight)) +
  geom_boxplot() +
  labs(x = "Edad", y = "Peso (kg)")
``` 

### Grupo 4

```{r WeightCC4, warning=F,message=F}

ggplot(g4, aes(group = age, x = age, y = Weight)) +
  geom_boxplot() +
  labs(x = "Edad", y = "Peso (kg)")
``` 

