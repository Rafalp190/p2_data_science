---
title: "Proyecto 2 Chus"
author: "Alejandro Vasquez"
date: "28 de agosto de 2018"
output: 
  html_document:

    number_sections: true

    toc: true

    fig_width: 8

    fig_height: 6

    theme: cosmo

    highlight: tango

    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(dplyr)
library(ggplot2)
```

# Lectura y unión de bases de datos


Leer datos de subjects, card1 y card2:

```{r read_data}
mainData <- as.data.frame(read_xlsx("./data/1-Subjects sex_ID_school_DOB.xlsx"))
c1 <-  as.data.frame(read_xlsx("./data/4-Card1.xlsx"))
c2 <-  as.data.frame(read_xlsx("./data/5-Card2.xlsx"))
```


Modificar los nombres de columnas y unión de bases de datos:

```{r merge}
colnames(mainData)[1] <- "Id"
colnames(c1)[2] <- "date" 
colnames(c2)[2] <- "date"

cards <- merge(c1, c2, by = c("Id", "date"))
completeData <- merge(mainData, cards, by = "Id")
completeData$age <- round(completeData$date - completeData$`DOB decimal`, 0)
```


## Exploración de variables y elminación de outliers

Gráfica de frecuencia de edades:

```{r age_freq, echo=FALSE}
ggplot(completeData, aes(x = age)) +
  geom_bar() +
  labs(x = "Edad", y = "Frecuencia")
```

Boxplots de altura por edad:

```{r boxplot_height1, echo=FALSE}
ggplot(completeData, aes(group = age, x = age, y = Height)) +
  geom_boxplot() +
  labs(x = "Edad", y = "Altura (cm)")
```

Las alturas de más de 250 cm no tienen sentido. Además, las edades mayores a 22 años tienen muy pocos datos. Se decidió removerlos:


```{r rem_outliers}
completeData <- completeData %>% 
  filter(Height < 250) %>% 
  filter(age < 23)
```

Gráfica de boxplots de altura por edades sin outliers:

```{r boxplot_height2, echo=FALSE}
ggplot(completeData, aes(group = age, x = age, y = Height)) +
  geom_boxplot() +
  labs(x = "Edad", y = "Altura (cm)")
```


Gráfica de boxplots de pesos por edades:
```{r boxplot_weight1, echo=FALSE}
ggplot(completeData, aes(group = age, x = age, y = Weight)) +
  geom_boxplot() +
  labs(x = "Edad", y = "Peso (kg)")
```

Pesos mayores a 200 kg no tienen sentidos. Se decidió eliminarlos:

```{r }
completeData <- completeData %>% 
  filter(Weight < 200)
```

Gráfica de boxplots de pesos por edades sin outliers:

```{r }
ggplot(completeData, aes(group = age, x = age, y = Weight)) +
  geom_boxplot() +
  labs(x = "Edad", y = "Peso (kg)")
```

Gráficas de regresión lineal entre peso y altura por edad:

```{r peso_altura, echo=FALSE}
for(i in 4:22){
  temp <- completeData %>% 
    filter(age == i)
  
  print(ggplot(temp, aes(x = Weight, y = Height)) + geom_point() + 
           labs(x = "Peso (kg)", y = "Altura (cm)", title = paste(i, " años")) +
    geom_smooth(method = lm, se = F))
}

```

Solo existen 4 datos para mediciones con cuatro y veintidos años de edad. Se eliminarán:


```{r rem_outliers2}
completeData <- completeData %>% 
  filter(age > 4) %>% 
  filter(age < 22)
```

Número de dientes contra altura:

```{r , echo=FALSE}
ggplot(completeData, aes(group = Dental, x = Dental, y = Height)) +
  geom_boxplot() +
  labs(x = "Número de dientes", y = "Altura (cm)")
```

No tiene sentido que hayan niños tan altos sin dientes permanentes "erupcionados". Según la Asociación Dental de América, se espera que a partir de los 6-7 años por lo menos se hayan desarrollado los incisivos centrales. Probablemente esos "0"s signifiquen que no fue registrado el dato. Para comprobar cuántos registros de niños mayores años no tienen dientes permanentes "erupcionados":


```{r check_teeth_age}
paste(round((nrow(filter(completeData, age > 7 & Dental == 0)) 
             / nrow(completeData) * 100),2), "%")
```

Más del 60% de los datos no tienen ese registro, por lo que no se utilizará esta columna.

```{r remove_Dental}
completeData <- completeData %>% 
  mutate(Dental = NULL)
```

IdSchool2, que indica si se cambiaron de colegio parece tener muchos NAs. Chequear:

```{r check_idschool2}
paste(round(nrow(filter(completeData, is.na(`IdSchool 2`))) / 
              nrow(completeData) * 100, 2), "%")
```

Casi el 100% de los registros no poseen esta información. Se eliminará esta columna. Además, se eliminarán las columnas *Repetition* y *RepetitionCard1* ya que estas proveen poca información acerca de la altura. Es más, los alumnos repitentes podrían distorsionar las predicciones.

```{r remove_idschool2_repetitions}


completeData <- completeData %>% 
  mutate(`IdSchool 2` = NULL) %>% 
  mutate(Repetition = NULL) %>% 
  mutate(RepetitionCard1 = NULL)

```


Visualizar los datos de pruebas de fuerza de agarre:

```{r hand_grip, echo=FALSE}
ggplot(completeData, aes(y = `Hand grip`, x = age, group = age)) +
  geom_boxplot() +
  labs(y = "fuerza de agarre (kg)", x = "Edad (años)")
```

No existen registros de pruebas de fuerza de agarre en los que se superen los 100 kg de fuerza de agarre, por lo que se eliminarán los outliers y se vuelve a graficar: 

```{r remove_handgrip_outliers, echo=FALSE}
completeData <- completeData %>% 
  filter(`Hand grip` < 100)
```

```{r hand_grip2, echo=FALSE}
ggplot(completeData, aes(y = `Hand grip`, x = age, group = age)) +
  geom_boxplot() +
  labs(y = "fuerza de agarre (kg)", x = "Edad (años)")
```

Ahora graficar la fuerza de agarre por edad:

```{r plot_handgrip_by_age, echo=FALSE}

for(i in 5:21){
  temp <- completeData %>% 
    filter(age == i)
  
  print(ggplot(temp, aes(x = `Hand grip`)) + 
          geom_bar() + 
           labs(y = "Frecuencia", 
                x = "fuerza de agarre (kg)", 
                title = paste(i, " años")
                )
  )
}



```

La fuerza de agarre presenta una distribución aparentemente normal desde los 5 hasta los 14 años. Sin embargo, a partir de los 15 años y sobre todo entre los 17 y 19 años, se pueden observar claramente dos distribuciones que se traslapan. Esto indica que en estas edades la diferencia de fuerza de agarre es mucho más marcada entre dos grupos que no se encuentran diferenciados. 

Probando agrupar por sexo:


```{r plot_handgrip_by_age, echo=FALSE}

for(i in 5:21){
  temp <- completeData %>% 
    filter(age == i)
  
  print(ggplot(temp, aes(x = `Hand grip`, fill = Sex)) + 
          geom_bar() + 
           labs(y = "Frecuencia", 
                x = "fuerza de agarre (kg)", 
                title = paste(i, " años")
                )
  )
}



```

Se observa claramente que a partir de los 15 años, los hombres tienen una distribución normal (aparentemente) con una media de fuerza de agarre mayor al de las mujeres. Por lo tanto, debemos considerarlos como dos grupos claramente distintos a partir de esa edad.


Por otra parte, se eliminarán otras variables poco útiles como *entering date*, *entering data* y *User*. También se eliminarán *DOB* y *DOB decimal* debido a que ya se calculó la edad en cada registro.

```{r remove_trash}

completeData <- completeData %>% 
  mutate(`entering date` = NULL) %>% 
  mutate(`entering data` = NULL) %>% 
  mutate(User.x = NULL) %>% 
  mutate(User.y = NULL) %>% 
  mutate(DOB = NULL) %>% 
  mutate(`DOB decimal` = NULL)

```
